// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// üè¢ M√ìDULO DE SUCURSALES
// ============================================================

model Branch {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  sales         Sale[]
  products      Product[]
  categories    Category[]
  presentations ProductPresentation[]
  inventories   Inventory[]
  orders        Order[]

  @@index([name])
  @@index([isActive])
}

model Sale {
  id            Int          @id @default(autoincrement())
  folio         String?
  total         Float
  status        String?
  //Sucursal
  branchId      Int?
  branch        Branch?      @relation(fields: [branchId], references: [id])
  //Caja de cobro
  cashRegister  String?      @default("Caja 1")
  paymentMethod String?
  createdAt     DateTime     @default(now())
  clientName    String?
  syncStatus    String       @default("pendiente")
  details       SaleDetail[]

  @@index([branchId])
}

model SaleDetail {
  id          Int      @id @default(autoincrement())
  quantity    Int
  price       Float
  subTotal    Float
  productName String?
  createdAt   DateTime @default(now())
  saleId      Int
  sale        Sale     @relation(fields: [saleId], references: [id])
}

// ============================================================
// üõçÔ∏è M√ìDULO DE PRODUCTOS
// ============================================================

model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  showInPOS   Boolean  @default(false)
  showInStore Boolean  @default(false) // Mostrar en tienda en l√≠nea (por defecto oculto)
  image       String?  // URL de la imagen de la categor√≠a
  branchId    Int?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  products Product[]

  @@index([branchId])
  @@index([name])
  @@index([showInStore])
}

model Product {
  id             Int      @id @default(autoincrement())
  code           String?
  name           String
  status         Int?
  saleType       String?
  price          Float
  cost           Float?
  description    String?
  icon           String?
  trackInventory Boolean? @default(false)
  isKit          Boolean  @default(false)
  showInStore    Boolean  @default(true) // Mostrar en tienda en l√≠nea (por defecto visible)
  branchId       Int?
  branch         Branch?  @relation(fields: [branchId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  presentations ProductPresentation[]
  inventory     Inventory?
  kitItems      KitItem[]             @relation("Kit")
  kitsAsItem    KitItem[]             @relation("KitProduct")
  images        ProductImage[]

  @@index([code])
  @@index([name])
  @@index([branchId])
  @@index([categoryId])
  @@index([showInStore])
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  url       String   // URL de la imagen en Cloudinary
  displayOrder Int   @default(0) // Orden de visualizaci√≥n
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([displayOrder])
}

model ProductPresentation {
  id        Int      @id @default(autoincrement())
  name      String
  quantity  Int
  unitPrice Float
  isDefault Boolean  @default(false)
  branchId  Int?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  kitItems KitItem[]

  @@index([productId])
  @@index([branchId])
}

model Inventory {
  id             Int      @id @default(autoincrement())
  productId      Int      @unique
  product        Product  @relation(fields: [productId], references: [id])
  currentStock   Int      @default(0)
  minStock       Int      @default(0)
  maxStock       Int?
  trackInventory Boolean  @default(false)
  branchId       Int?
  branch         Branch?  @relation(fields: [branchId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([productId])
  @@index([branchId])
}

model KitItem {
  id             Int                  @id @default(autoincrement())
  kitId          Int
  kit            Product              @relation("Kit", fields: [kitId], references: [id], onDelete: Cascade)
  productId      Int
  product        Product              @relation("KitProduct", fields: [productId], references: [id])
  presentationId Int?
  presentation   ProductPresentation? @relation(fields: [presentationId], references: [id])
  quantity       Float                @default(1)
  displayOrder   Int                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@unique([kitId, productId, presentationId])
  @@index([kitId])
  @@index([productId])
}

// ============================================================
// üë§ M√ìDULO DE USUARIOS Y AUTENTICACI√ìN
// ============================================================

enum UserRole {
  ADMIN
  CLIENTE
}

enum RegistrationSource {
  WEB
  APP
}

model User {
  id                 Int                @id @default(autoincrement())
  email              String              @unique
  name               String
  phone              String?
  password           String // Hash de la contrase√±a
  role               UserRole            @default(CLIENTE)
  registrationSource RegistrationSource? // Origen del registro: WEB o APP
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // Relaciones
  orders              Order[]
  cashExpressRequests CashExpressRequest[]
  balanceHistory      CashExpressBalanceHistory[]
  notifications       Notification[]

  @@index([email])
  @@index([role])
  @@index([registrationSource])
}

// ============================================================
// üì¶ M√ìDULO DE PEDIDOS (ORDERS)
// ============================================================

enum OrderStatus {
  PENDIENTE
  CONFIRMADO
  EN_PREPARACION
  LISTO
  ENTREGADO
  CANCELADO
}

model Order {
  id        Int         @id @default(autoincrement())
  folio     String?     @unique
  total     Float
  status    OrderStatus @default(PENDIENTE)
  notes     String?
  userId    Int
  user      User        @relation(fields: [userId], references: [id])
  branchId  Int?
  branch    Branch?     @relation(fields: [branchId], references: [id])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  items OrderItem[]

  @@index([userId])
  @@index([branchId])
  @@index([status])
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   Int
  productName String
  quantity    Int
  unitPrice   Float
  subtotal    Float
  isAvailable Boolean? // null = no revisado, true = disponible, false = no disponible
  createdAt   DateTime @default(now())

  @@index([orderId])
}

// ============================================================
// üí∞ M√ìDULO DE EFECTIVO EXPRESS
// ============================================================

enum CashExpressStatus {
  PENDIENTE
  EN_ESPERA_CONFIRMACION
  REBOTADO
  DEPOSITO_VALIDADO
  ENTREGADO
  CANCELADO
}

model CashExpressConfig {
  id                   Int     @id @default(autoincrement())
  // D√≠as de servicio (JSON array: [1,2,3,4,5] = lunes a viernes)
  serviceDays          String  @default("[1,2,3,4,5]") // 0=domingo, 1=lunes, ..., 6=s√°bado
  // Horario de inicio (formato: "09:00")
  startTime            String  @default("09:00")
  // Horario de fin (formato: "20:00")
  endTime              String  @default("20:00")
  // D√≠as festivos (JSON array de fechas: ["2024-12-25", "2025-01-01"])
  holidays             String  @default("[]")
  // Mensaje personalizado para d√≠as no laborables
  nonWorkingDayMessage String? @default("Tu solicitud ser√° procesada el pr√≥ximo d√≠a h√°bil.")
  // Saldo disponible actual
  availableBalance     Float   @default(0)
  // Abono m√≠nimo diario (por defecto $500)
  dailyMinimumDeposit  Float   @default(500)
  // Monto m√°ximo de dep√≥sito a enviar
  maxAmount            Float   @default(1000)
  // Porcentaje de comisi√≥n (por defecto 6.5%)
  commissionPercentage Float   @default(6.5)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con historial de abonos
  balanceHistory CashExpressBalanceHistory[]
  // Relaci√≥n con cuentas bancarias
  bankAccounts CashExpressBankAccount[]

  @@map("cash_express_config")
}

model CashExpressBalanceHistory {
  id              Int     @id @default(autoincrement())
  amount          Float // Monto del abono (positivo) o retiro (negativo)
  description     String? // Descripci√≥n del movimiento
  previousBalance Float // Saldo anterior
  newBalance      Float // Saldo nuevo
  userId          Int? // Usuario que realiz√≥ el movimiento (admin)
  user            User?   @relation(fields: [userId], references: [id])

  createdAt           DateTime           @default(now())
  CashExpressConfig   CashExpressConfig? @relation(fields: [cashExpressConfigId], references: [id])
  cashExpressConfigId Int?

  // Relaci√≥n con solicitud (para retiros por entrega)
  cashExpressRequestId Int?
  cashExpressRequest   CashExpressRequest? @relation(fields: [cashExpressRequestId], references: [id])

  @@index([createdAt])
  @@index([cashExpressRequestId])
  @@map("cash_express_balance_history")
}

model CashExpressBankAccount {
  id                   Int     @id @default(autoincrement())
  // Nombre del beneficiario
  beneficiaryName      String
  // N√∫mero de cuenta
  accountNumber        String
  // CLABE (opcional)
  clabe                String?
  // Concepto o referencia para el dep√≥sito
  concept              String?
  // Banco o instituci√≥n financiera
  bankName             String?
  // Orden de visualizaci√≥n
  displayOrder         Int     @default(0)
  // Si est√° activa
  isActive             Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con configuraci√≥n
  cashExpressConfigId Int
  CashExpressConfig   CashExpressConfig @relation(fields: [cashExpressConfigId], references: [id])

  @@index([cashExpressConfigId])
  @@index([isActive])
  @@map("cash_express_bank_accounts")
}

model CashExpressRequest {
  id             Int     @id @default(autoincrement())
  folio          String? @unique
  amount         Float // Monto a enviar
  commission     Float   @default(65) // Comisi√≥n
  totalToDeposit Float // Total a depositar (amount + commission)

  // Datos del remitente (opcionales hasta que se valide el dep√≥sito)
  senderName  String?
  senderPhone String?

  // Datos del destinatario (opcionales hasta que se valide el dep√≥sito)
  recipientName  String?
  recipientPhone String?
  relationship   String?

  status             CashExpressStatus @default(PENDIENTE)
  rejectionReason    String? // Motivo de rechazo si fue rebotada
  depositReceipt     String? // URL o base64 del comprobante de dep√≥sito
  receiptSentAt      DateTime? // Fecha de env√≠o del comprobante a revisi√≥n
  depositValidatedAt DateTime? // Fecha de validaci√≥n del dep√≥sito
  estimatedDeliveryDate DateTime? // Fecha estimada de entrega calculada al crear la solicitud
  availableFrom      DateTime? // Fecha/hora desde la cual est√° disponible para recoger
  deliveredAt        DateTime?
  signedReceipt      String? // URL del comprobante firmado por el cliente

  userId Int
  user   User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con historial de balance (para retiros por entrega)
  balanceHistory CashExpressBalanceHistory[]

  @@index([userId])
  @@index([status])
  @@index([folio])
}

// ============================================================
// üîî M√ìDULO DE NOTIFICACIONES
// ============================================================

model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Tipo de notificaci√≥n
  type        String    // 'cash_express' o 'order'
  entityId    Int       // ID de la solicitud o pedido
  
  // Informaci√≥n de la notificaci√≥n
  title       String
  message     String
  action      String?   // Descripci√≥n de qu√© hacer
  
  // Estado
  status      String    // Estado actual (PENDIENTE, CONFIRMADO, etc.)
  previousStatus String? // Estado anterior
  
  // Le√≠do
  read        Boolean   @default(false)
  readAt      DateTime?
  
  // Ocultar (el usuario la oculta pero no se elimina de la BD)
  hiddenAt    DateTime?
  
  // Expiraci√≥n (solo informativa; ya no se usa para eliminar)
  expiresAt   DateTime  // Fecha de expiraci√≥n (1 d√≠a si le√≠da, 5 d√≠as si no)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([read])
  @@index([hiddenAt])
  @@index([expiresAt])
  @@index([type, entityId])
  @@index([createdAt])
}

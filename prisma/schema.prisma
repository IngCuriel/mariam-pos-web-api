// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// üè¢ M√ìDULO DE SUCURSALES
// ============================================================

model Branch {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  sales         Sale[]
  products      Product[]
  categories    Category[]
  presentations ProductPresentation[]
  inventories   Inventory[]
  orders        Order[]

  @@index([name])
  @@index([isActive])
}

model Sale {
  id            Int          @id @default(autoincrement())
  folio         String?
  total         Float
  status        String?
  //Sucursal
  branchId      Int?
  branch        Branch?      @relation(fields: [branchId], references: [id])
  //Caja de cobro
  cashRegister  String?      @default("Caja 1")
  paymentMethod String?
  createdAt     DateTime     @default(now())
  clientName    String?
  syncStatus    String       @default("pendiente")
  details       SaleDetail[]

  @@index([branchId])
}

model SaleDetail {
  id          Int      @id @default(autoincrement())
  quantity    Int
  price       Float
  subTotal    Float
  productName String?
  createdAt   DateTime @default(now())
  saleId      Int
  sale        Sale     @relation(fields: [saleId], references: [id])
}

// ============================================================
// üõçÔ∏è M√ìDULO DE PRODUCTOS
// ============================================================

model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  showInPOS   Boolean  @default(false)
  branchId    Int?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  createdAt   DateTime @default(now())

  products Product[]

  @@index([branchId])
  @@index([name])
}

model Product {
  id             Int      @id @default(autoincrement())
  code           String?
  name           String
  status         Int?
  saleType       String?
  price          Float
  cost           Float?
  description    String?
  icon           String?
  trackInventory Boolean? @default(false)
  isKit          Boolean  @default(false)
  branchId       Int?
  branch         Branch?  @relation(fields: [branchId], references: [id])
  createdAt      DateTime @default(now())

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  presentations ProductPresentation[]
  inventory     Inventory?
  kitItems      KitItem[]             @relation("Kit")
  kitsAsItem    KitItem[]             @relation("KitProduct")

  @@index([code])
  @@index([name])
  @@index([branchId])
  @@index([categoryId])
}

model ProductPresentation {
  id        Int      @id @default(autoincrement())
  name      String
  quantity  Int
  unitPrice Float
  isDefault Boolean  @default(false)
  branchId  Int?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  kitItems KitItem[]

  @@index([productId])
  @@index([branchId])
}

model Inventory {
  id             Int      @id @default(autoincrement())
  productId      Int      @unique
  product        Product  @relation(fields: [productId], references: [id])
  currentStock   Int      @default(0)
  minStock       Int      @default(0)
  maxStock       Int?
  trackInventory Boolean  @default(false)
  branchId       Int?
  branch         Branch?  @relation(fields: [branchId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([productId])
  @@index([branchId])
}

model KitItem {
  id             Int                  @id @default(autoincrement())
  kitId          Int
  kit            Product              @relation("Kit", fields: [kitId], references: [id], onDelete: Cascade)
  productId      Int
  product        Product              @relation("KitProduct", fields: [productId], references: [id])
  presentationId Int?
  presentation   ProductPresentation? @relation(fields: [presentationId], references: [id])
  quantity       Float                @default(1)
  displayOrder   Int                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@unique([kitId, productId, presentationId])
  @@index([kitId])
  @@index([productId])
}

// ============================================================
// üë§ M√ìDULO DE USUARIOS Y AUTENTICACI√ìN
// ============================================================

enum UserRole {
  ADMIN
  CLIENTE
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  phone     String?
  password  String // Hash de la contrase√±a
  role      UserRole @default(CLIENTE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  orders              Order[]
  cashExpressRequests CashExpressRequest[]
  balanceHistory      CashExpressBalanceHistory[]

  @@index([email])
  @@index([role])
}

// ============================================================
// üì¶ M√ìDULO DE PEDIDOS (ORDERS)
// ============================================================

enum OrderStatus {
  PENDIENTE
  CONFIRMADO
  EN_PREPARACION
  LISTO
  ENTREGADO
  CANCELADO
}

model Order {
  id        Int         @id @default(autoincrement())
  folio     String?     @unique
  total     Float
  status    OrderStatus @default(PENDIENTE)
  notes     String?
  userId    Int
  user      User        @relation(fields: [userId], references: [id])
  branchId  Int?
  branch    Branch?     @relation(fields: [branchId], references: [id])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  items OrderItem[]

  @@index([userId])
  @@index([branchId])
  @@index([status])
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   Int
  productName String
  quantity    Int
  unitPrice   Float
  subtotal    Float
  createdAt   DateTime @default(now())

  @@index([orderId])
}

// ============================================================
// üí∞ M√ìDULO DE EFECTIVO EXPRESS
// ============================================================

enum CashExpressStatus {
  PENDIENTE
  EN_ESPERA_CONFIRMACION
  REBOTADO
  DEPOSITO_VALIDADO
  ENTREGADO
  CANCELADO
}

model CashExpressConfig {
  id                   Int     @id @default(autoincrement())
  // D√≠as de servicio (JSON array: [1,2,3,4,5] = lunes a viernes)
  serviceDays          String  @default("[1,2,3,4,5]") // 0=domingo, 1=lunes, ..., 6=s√°bado
  // Horario de inicio (formato: "09:00")
  startTime            String  @default("09:00")
  // Horario de fin (formato: "20:00")
  endTime              String  @default("20:00")
  // D√≠as festivos (JSON array de fechas: ["2024-12-25", "2025-01-01"])
  holidays             String  @default("[]")
  // Mensaje personalizado para d√≠as no laborables
  nonWorkingDayMessage String? @default("Tu solicitud ser√° procesada el pr√≥ximo d√≠a h√°bil.")
  // Saldo disponible actual
  availableBalance     Float   @default(0)
  // Abono m√≠nimo diario (por defecto $500)
  dailyMinimumDeposit  Float   @default(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con historial de abonos
  balanceHistory CashExpressBalanceHistory[]

  @@map("cash_express_config")
}

model CashExpressBalanceHistory {
  id              Int     @id @default(autoincrement())
  amount          Float // Monto del abono (positivo) o retiro (negativo)
  description     String? // Descripci√≥n del movimiento
  previousBalance Float // Saldo anterior
  newBalance      Float // Saldo nuevo
  userId          Int? // Usuario que realiz√≥ el movimiento (admin)
  user            User?   @relation(fields: [userId], references: [id])

  createdAt           DateTime           @default(now())
  CashExpressConfig   CashExpressConfig? @relation(fields: [cashExpressConfigId], references: [id])
  cashExpressConfigId Int?

  @@index([createdAt])
  @@map("cash_express_balance_history")
}

model CashExpressRequest {
  id             Int     @id @default(autoincrement())
  folio          String? @unique
  amount         Float // Monto a enviar
  commission     Float   @default(65) // Comisi√≥n
  totalToDeposit Float // Total a depositar (amount + commission)

  // Datos del remitente (opcionales hasta que se valide el dep√≥sito)
  senderName  String?
  senderPhone String?

  // Datos del destinatario (opcionales hasta que se valide el dep√≥sito)
  recipientName  String?
  recipientPhone String?
  relationship   String?

  status             CashExpressStatus @default(PENDIENTE)
  rejectionReason    String? // Motivo de rechazo si fue rebotada
  depositReceipt     String? // URL o base64 del comprobante de dep√≥sito
  receiptSentAt      DateTime? // Fecha de env√≠o del comprobante a revisi√≥n
  depositValidatedAt DateTime? // Fecha de validaci√≥n del dep√≥sito
  estimatedDeliveryDate DateTime? // Fecha estimada de entrega calculada al crear la solicitud
  availableFrom      DateTime? // Fecha/hora desde la cual est√° disponible para recoger
  deliveredAt        DateTime?
  signedReceipt      String? // URL del comprobante firmado por el cliente

  userId Int
  user   User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([folio])
}
